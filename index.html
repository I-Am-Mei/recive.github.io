<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project Dashboard</title>
<style>
body { font-family: Arial; margin: 0; background: #eef2f7; }
header { background: #007bff; color: white; padding: 20px; text-align: center; font-size: 24px; }
.container { display: flex; flex-wrap: wrap; padding: 20px; justify-content: space-around; }
.card { background: white; border-radius: 10px; padding: 20px; margin: 10px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.2s; }
.card:hover { transform: scale(1.02); }
.inactive-box { background: #ffdede; border-radius: 10px; padding: 20px; margin: 20px; }
input, select, textarea { width: 100%; padding: 10px; margin: 6px 0; border-radius: 5px; border: 1px solid #ccc; }
button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 6px; }
button:hover { background: #0056b3; }
h3 { margin-top: 0; font-size: 18px; }
section { margin-bottom: 40px; }
.time-off-box { background: #fff7cc; padding: 12px; border-radius: 10px; margin-top: 10px; }
</style>
</head>
<body>

<header>
    <h1>Project Dashboard - Team Management</h1>
</header>

<!-- Panel for Heads -->
<div id="headPanel" style="padding:20px; display:none; border-bottom: 2px solid #ccc;">
    <h2>Add New Member</h2>
    <input type="text" id="newName" placeholder="Enter Member Name">
    <select id="newRole">
        <option value="Writer">Writer</option>
        <option value="Animator">Animator</option>
        <option value="Artist">Artist</option>
        <option value="Composer">Composer</option>
        <option value="Head">Head</option>
    </select>
    <label><input type="checkbox" id="inactiveCheck"> Inactive</label>
    <button onclick="addMember()">Add Member</button>
    <div id="newPasswordDisplay" style="margin-top:10px; color:darkred; font-weight:bold;"></div>

    <h2>Assign Task</h2>
    <input type="text" id="taskTitle" placeholder="Task Title">
    <textarea id="taskDesc" placeholder="Task Description"></textarea>
    <select id="taskAssignee"></select>
    <button onclick="assignTask()">Assign Task</button>

    <h2>Pending Time-Off Requests</h2>
    <div id="timeOffRequests"></div>
</div>

<!-- Panel for Workers -->
<div id="workerPanel" style="padding:20px; display:none; border-bottom:2px solid #ccc;">
    <h2 id="workerWelcome">Welcome!</h2>
    <h3>Request Time Off</h3>
    <input type="date" id="timeOffDate">
    <input type="text" id="timeOffReason" placeholder="Reason">
    <button onclick="requestTimeOff()">Submit Request</button>
</div>

<section id="tasksSection" style="padding:20px;">
    <h2>My Tasks</h2>
    <div id="myTasks"></div>
</section>

<section style="padding:20px;">
    <h2>All Members Overview</h2>
    <div class="container" id="activeMembers"></div>

    <h2>Inactive Members</h2>
    <div class="inactive-box" id="inactiveMembers"></div>
</section>

<script>
// =========================
// Persistent storage
// =========================
let users = JSON.parse(localStorage.getItem('users') || '[]');
let members = JSON.parse(localStorage.getItem('members') || '[]');
let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
let timeOffs = JSON.parse(localStorage.getItem('timeOffs') || '[]');
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

// =========================
// On page load
// =========================
window.addEventListener('DOMContentLoaded', () => {
    if(!currentUser){
        alert("You must log in first!");
        window.location.href = "login.html";
        return;
    }

    if(currentUser.role?.trim().toLowerCase() === 'head') {
        document.getElementById('headPanel').style.display = 'block';
        updateAssigneeDropdown();
        renderTimeOffRequests();
    } else {
        document.getElementById('workerPanel').style.display = 'block';
        document.getElementById('workerWelcome').textContent = `Welcome, ${currentUser.name}!`;
    }

    renderMembers();
    renderTasks();
    renderTimeOffs();
});

// =========================
// MEMBERS
// =========================
function renderMembers() {
    const activeDiv = document.getElementById('activeMembers');
    const inactiveDiv = document.getElementById('inactiveMembers');
    activeDiv.innerHTML = '';
    inactiveDiv.innerHTML = '';

    const roles = ['Writer','Animator','Artist','Composer','Head'];
    roles.forEach(role => {
        const roleMembers = members.filter(m => m.role === role && !m.inactive);
        if(roleMembers.length > 0){
            const roleHeader = document.createElement('h3');
            roleHeader.textContent = role;
            activeDiv.appendChild(roleHeader);

            roleMembers.forEach(m => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <strong>${m.name}</strong><br>
                    Role: ${m.role}<br>
                    ${currentUser.role?.toLowerCase() === 'head'
                        ? `<button onclick="removeMember('${m.username}')">Remove</button>`
                        : ''}
                `;
                activeDiv.appendChild(card);
            });
        }
    });

    members.filter(m => m.inactive).forEach(m => {
        const div = document.createElement('div');
        div.textContent = `${m.name} (${m.role})`;
        inactiveDiv.appendChild(div);
    });
}

function addMember() {
    if(currentUser.role?.toLowerCase() !== 'head') {
        alert("Only Head can add members.");
        return;
    }

    const name = document.getElementById('newName').value.trim();
    const role = document.getElementById('newRole').value;
    const inactive = document.getElementById('inactiveCheck').checked;
    if(!name) { alert('Please enter a name'); return; }

    const username = name.toLowerCase().replace(/\s+/g,'') + Date.now();
    const password = Math.random().toString(36).slice(-8); // simple random password

    members.push({name, role, username, inactive});
    users.push({username, password, role, name});
    localStorage.setItem('members', JSON.stringify(members));
    localStorage.setItem('users', JSON.stringify(users));

    document.getElementById('newName').value = '';
    document.getElementById('inactiveCheck').checked = false;
    document.getElementById('newPasswordDisplay').textContent = `Password for ${name}: ${password}`;

    renderMembers();
    updateAssigneeDropdown();
}

function removeMember(username) {
    if(currentUser.role?.toLowerCase() !== 'head') return;
    if(confirm('Remove this member?')) {
        members = members.filter(m => m.username !== username);
        users = users.filter(u => u.username !== username);
        localStorage.setItem('members', JSON.stringify(members));
        localStorage.setItem('users', JSON.stringify(users));
        renderMembers();
        updateAssigneeDropdown();
    }
}

// =========================
// TASKS
// =========================
function updateAssigneeDropdown() {
    const select = document.getElementById('taskAssignee');
    if(!select) return;
    select.innerHTML = '';
    members.filter(m => !m.inactive).forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.username;
        opt.textContent = m.name;
        select.appendChild(opt);
    });
}

function assignTask() {
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDesc').value.trim();
    const assignedTo = document.getElementById('taskAssignee').value;

    if(!title || !assignedTo) { alert("Fill in task details"); return; }

    tasks.push({title, description, assignedTo, status:'Pending'});
    localStorage.setItem('tasks', JSON.stringify(tasks));

    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDesc').value = '';
    renderTasks();
}

function renderTasks() {
    const taskDiv = document.getElementById('myTasks');
    if(!taskDiv) return;
    taskDiv.innerHTML = '';

    const myTasks = tasks.filter(t => t.assignedTo === currentUser.username);
    if(myTasks.length === 0) {
        taskDiv.textContent = 'No tasks assigned.';
        return;
    }

    myTasks.forEach(t => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <strong>${t.title}</strong><br>
            ${t.description}<br>
            Status: ${t.status}
        `;
        taskDiv.appendChild(card);
    });
}

// =========================
// TIME OFF
// =========================
function requestTimeOff() {
    const date = document.getElementById('timeOffDate').value;
    const reason = document.getElementById('timeOffReason').value.trim();
    if(!date || !reason) { alert("Enter date and reason"); return; }

    timeOffs.push({username: currentUser.username, date, reason, status:'Pending'});
    localStorage.setItem('timeOffs', JSON.stringify(timeOffs));

    document.getElementById('timeOffDate').value = '';
    document.getElementById('timeOffReason').value = '';
    renderTimeOffs();
}

function renderTimeOffs() {
    const timeDiv = document.getElementById('myTimeOffs') || document.createElement('div');
    timeDiv.id = 'myTimeOffs';
    document.getElementById('workerPanel')?.appendChild(timeDiv);
    timeDiv.innerHTML = '<h3>My Time Off Requests</h3>';

    const myTimeOffs = timeOffs.filter(to => to.username === currentUser.username);
    if(myTimeOffs.length === 0) {
        timeDiv.innerHTML += 'No time off requests.';
        return;
    }

    myTimeOffs.forEach(to => {
        const card = document.createElement('div');
        card.className = 'time-off-box';
        card.textContent = `Date: ${to.date}, Reason: ${to.reason}, Status: ${to.status}`;
        timeDiv.appendChild(card);
    });
}

function renderTimeOffRequests() {
    const div = document.getElementById('timeOffRequests');
    div.innerHTML = '';
    timeOffs.forEach((to, idx) => {
        const user = members.find(m => m.username === to.username);
        const card = document.createElement('div');
        card.className = 'time-off-box';
        card.innerHTML = `
            <strong>${user?.name || to.username}</strong> requested off on ${to.date}<br>
            Reason: ${to.reason}<br>
            Status: ${to.status}<br>
            <button onclick="approveTimeOff(${idx})">Approve</button>
            <button onclick="denyTimeOff(${idx})">Deny</button>
        `;
        div.appendChild(card);
    });
}

function approveTimeOff(idx) {
    timeOffs[idx].status = 'Approved';
    localStorage.setItem('timeOffs', JSON.stringify(timeOffs));
    renderTimeOffRequests();
}
function denyTimeOff(idx) {
    timeOffs[idx].status = 'Denied';
    localStorage.setItem('timeOffs', JSON.stringify(timeOffs));
    renderTimeOffRequests();
}
</script>
</body>
</html>
